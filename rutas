
#Medio Publicacion...................................................................................................................................

@app.route('/mediopublic')
def mediopublic():
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4' )
    cursor = conn.cursor()
    cursor.execute('select idMedioPublic, descripcion from mediopublic order by idMedioPublic')
    datos = cursor.fetchall()
    return render_template("mediopiblic.html", comentarios = datos)

@app.route('/mediopublic_editar/<string:id>')
def mediopublic_editar(id):
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('select idMedioPublic, descripcion from mediopublic where idMedioPublic = %s', (id))
    dato  = cursor.fetchall()
    return render_template("mediopublic_edi.html", comentar=dato[0])

@app.route('/mediopublic_fedita/<string:id>',methods=['POST'])
def mediopublic_fedita(id):
    if request.method == 'POST':
        desc=request.form['descripcion']
        conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
        cursor = conn.cursor()
        cursor.execute('update mediopublic set descripcion=%s where idMedioPublic=%s', (desc,id))
        conn.commit()
    return redirect(url_for('idioma'))

@app.route('/mediopublic_borrar/<string:id>')
def mediopublic_borrar(id):
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('delete from mediopublic where idMedioPublic {0}'.format(id))
    conn.commit()
    return redirect(url_for('mediopublic'))

@app.route('/mediopublic_agregar')
def mediopublic_agregar():
    return render_template("area_agr.html")

@app.route('/idioma_fagrega', methods=['POST'])
def mediopublic_fagrega():
    if request.method == 'POST':
        desc = request.form['descripcion']
        conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4' )
        cursor = conn.cursor()
        cursor.execute('insert into mediopublic (descripcion) values (%s)',(desc))
        conn.commit()
    return redirect(url_for('mediopublic'))

#Trabajadores-------------------------------------------

@app.route('/trabajadores')
def trabajadores():
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4' )
    cursor = conn.cursor()
    cursor.execute('select idTrabajador, NombreTrab from trabajadores order by idTrabajador')
    datos = cursor.fetchall()
    return render_template("trabajadores.html", trab = datos)




@app.route('/trabajador_agregar')
def trabajador_agregar():
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('select idArea, descripcion from area ')
    datos1 = cursor.fetchall()

    

    cursor.execute('select idEstadoCivil, descripcion from estado_civil ')
    datos2 = cursor.fetchall()

    cursor.execute('select idEscolaridad, descripcion from escolaridad ')
    datos3 = cursor.fetchall()

    cursor.execute('select idGradoAvance, descripcion from grado_avance ')
    datos4 = cursor.fetchall()

    cursor.execute('select idCarrera, descripcion from carrera ')
    datos5 = cursor.fetchall()

    cursor.execute('select idIdioma, descripcion from idioma ')
    datos6 = cursor.fetchall()

    cursor.execute('select idHabilidad, descripcion from habilidad ')
    datos7 = cursor.fetchall()

    cursor.execute('select idPuesto, nomPuesto from puesto ')
    datos8= cursor.fetchall()

    return render_template("trabajador_agr.html", catArea=datos1, catEdoCivil=datos2, catEscolaridad=datos3,
                           catGradoAvance=datos4, catCarrera=datos5, catIdioma=datos6, catHabilidad=datos7, catPuesto=datos8)

@app.route('/trabajador_fagrega', methods=['POST'])
def trabajador_fagrega():
    if request.method == 'POST':

        if  'idArea' in request.form:
            idAr = request.form['idArea']
        else:
            idAr = '1'
        if 'idEstadoCivil' in request.form:
            idEC = request.form['idEstadoCivil']
        else:
            idEC = '1'
        if 'idPuesto' in request.form:
            idPu = request.form['idPuesto']
        else:
            idPu = '1'
        if 'idEscolaridad' in request.form:
            idEs = request.form['idEscolaridad']
        else:
            idEs = '1'
        if 'idGradoAvance' in request.form:
            idGA = request.form['idGradoAvance']
        else:
            idGA = '1'
        if 'idCarrera' in request.form:
            idCa = request.form['idCarrera']
        else:
            idCa = '1'
        if 'sexo' in request.form:
            sex = request.form['sexo']
        else:
            sex = '1'
        
        nomT = request.form['nomtrab']
        eda = request.form['edad']



    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('insert into trabajadores (idArea, idPuesto, nombreTrab, edad,sexo,idEstadoCivil,idEscolaridad,idGradoAvance,idCarrera'') values (%s,%s,%s,%s,%s,%s,%s,%s,%s)',( idAr, idPu, nomT, eda, sex ,idEC, idEs, idGA, idCa))
    conn.commit()

    cursor.execute('select idTrabajador from trabajadores where idTrabajador=(select max(idTrabajador) from trabajadores) ')
    dato = cursor.fetchall()
    idpue = dato[0]
    idP = idpue[0]

    cursor.execute('select count(*) from idioma ')
    dato = cursor.fetchall()
    nidio = dato[0]
    ni = nidio[0] + 1

    for i in range(1, ni):
        idio = 'i' + str(i)
        if idio in request.form:
            cursor.execute('insert into trabajador_has_idioma(idTrabajador,idIdioma) values (%s,%s)', (idP, i))
            conn.commit()

    cursor.execute('select count(*) from habilidad ')
    dato = cursor.fetchall()
    nhab = dato[0]
    nh =nhab[0]+1

    for i in range(1,nh):
        habi = 'h' + str(i)
        if habi in request.form:
            cursor.execute('insert into trabajador_has_habilidad(idTrabajador,idHabilidad) values (%s,%s)', (idP,i))
            conn.commit()

    return redirect(url_for('trabajadores'))

@app.route('/trabajadores_borrar/<string:idP>')
def trabajadores_borrar(idP):
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('delete from trabajadores where idTrabajador = %s',(idP))
    conn.commit()
    cursor.execute('delete from trabajador_has_habilidad where idTrabajador =%s ', (idP))
    conn.commit()
    cursor.execute('delete from trabajador_has_idioma where idTrabajador =%s ', (idP))
    conn.commit()
    return redirect(url_for('trabajadores'))


@app.route('/trabajador_editar/<string:idP>')
def trabajador_editar(idP):
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()

    cursor.execute('select idTrabajador, idArea, idPuesto, nombreTrab, edad, sexo, idEstadoCivil, idEscolaridad, idGradoAvance, idCarrera from trabajadores where idTrabajador = %s', (idP))
    dato = cursor.fetchall()

    cursor.execute('select idArea, descripcion from area')
    datos1 = cursor.fetchall()

    cursor.execute('select idPuesto, nomPuesto from puesto')
    datos2 = cursor.fetchall()

    cursor.execute('select idEstadoCivil, descripcion from estado_civil')
    datos3 = cursor.fetchall()

    cursor.execute('select idEscolaridad, descripcion from escolaridad')
    datos4 = cursor.fetchall()

    cursor.execute('select idGradoAvance, descripcion from grado_avance')
    datos5 = cursor.fetchall()

    cursor.execute('select idCarrera, descripcion from carrera')
    datos6 = cursor.fetchall()

    cursor.execute('select idIdioma, descripcion from idioma')
    datos7 = cursor.fetchall()

    cursor.execute('select idHabilidad, descripcion from habilidad')
    datos8 = cursor.fetchall()

    cursor.execute('select a.idArea, a.descripcion from area a, trabajadores b where a.idArea = b.idArea and b.idTrabajador = %s', (idP))
    datos9 = cursor.fetchall()

    cursor.execute('select a.idPuesto, a.nomPuesto from puesto a, trabajadores b where a.idPuesto = b.idPuesto and b.idTrabajador = %s', (idP))
    datos10 = cursor.fetchall()

    cursor.execute('select a.idEstadoCivil, a.descripcion from estado_civil a, trabajadores b where a.idEstadoCivil = b.idEstadoCivil and b.idTrabajador = %s', (idP))
    datos11 = cursor.fetchall()

    cursor.execute('select a.idEscolaridad, a.descripcion from escolaridad a, trabajadores b where a.idEscolaridad = b.idEscolaridad and b.idTrabajador = %s', (idP))
    datos12 = cursor.fetchall()

    cursor.execute('select a.idGradoAvance, a.descripcion from grado_avance a, trabajadores b where a.idGradoAvance = b.idGradoAvance and b.idTrabajador = %s', (idP))
    datos13 = cursor.fetchall()

    cursor.execute('select a.idCarrera, a.descripcion from carrera a, trabajadores b where a.idCarrera = b.idCarrera and b.idTrabajador = %s', (idP))
    datos14 = cursor.fetchall()

    cursor.execute('select a.idTrabajador, b.idIdioma, b.descripcion from trabajadores a, idioma b, trabajador_has_idioma c where a.idTrabajador = c.idTrabajador and b.idIdioma = c.idIdioma and a.idTrabajador = %s', (idP))
    datos15 = cursor.fetchall()

    cursor.execute('select a.idTrabajador, b.idHabilidad, b.descripcion from trabajadores a, habilidad b, trabajador_has_habilidad c where a.idTrabajador = c.idTrabajador and b.idHabilidad = c.idHabilidad and a.idTrabajador = %s', (idP))
    datos16 = cursor.fetchall()

    return render_template("trabajador_edi.html", dat=dato[0], catArea=datos1, catPuesto=datos2, catEdoCivil=datos3, catEscolaridad=datos4,
                           catGradoAvance=datos5, catCarrera=datos6, catIdioma=datos7, catHabilidad=datos8,
                           Area=datos9[0], Puesto=datos10[0], EdoCivil=datos11[0], Escolaridad=datos12[0], GradoAvance=datos13[0],
                           Carrera=datos14[0], Idioma=datos15, Habilidad=datos16)


@app.route('/trabajador_fedita/<string:idP>', methods=['POST'])
def trabajador_fedita(idP):
    if request.method == 'POST':
        idAr = request.form['idArea']
        idPu = request.form['idPuesto']
        nomT = request.form['nomtrab']
        eda = request.form['edad']
        sex = request.form['sexo']
        idEC = request.form['idEstadoCivil']
        idEs = request.form['idEscolaridad']
        idGA = request.form['idGradoAvance']
        idCa = request.form['idCarrera']
        
        conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
        cursor = conn.cursor()
        
        cursor.execute(
            'UPDATE trabajadores SET idArea = %s, idPuesto = %s, NombreTrab = %s, edad = %s, sexo = %s, '
            'idEstadoCivil = %s, idEscolaridad = %s, idGradoAvance = %s, idCarrera = %s WHERE idTrabajador = %s',
            (idAr, idPu, nomT, eda, sex, idEC, idEs, idGA, idCa, idP)
        )
        conn.commit()
        
        cursor.execute('DELETE FROM trabajador_has_habilidad WHERE idTrabajador = %s', (idP,))
        conn.commit()
        
        cursor.execute('DELETE FROM trabajador_has_idioma WHERE idTrabajador = %s', (idP,))
        conn.commit()
        
        cursor.execute('SELECT COUNT(*) FROM idioma')
        dato = cursor.fetchone()
        nidio = dato[0]
        ni = nidio + 1
        
        for i in range(1, ni):
            idio = 'i' + str(i)
            if idio in request.form:
                cursor.execute('INSERT INTO trabajador_has_idioma(idTrabajador, idIdioma) VALUES (%s, %s)', (idP, i))
                conn.commit()
        
        cursor.execute('SELECT COUNT(*) FROM habilidad')
        dato = cursor.fetchone()
        nhab = dato[0]
        nh = nhab + 1
        
        for i in range(1, nh):
            habi = 'h' + str(i)
            if habi in request.form:
                cursor.execute('INSERT INTO Trabajador_has_habilidad(idTrabajador, idHabilidad) VALUES (%s, %s)', (idP, i))
                conn.commit()
        
        return redirect(url_for('trabajadores'))
    
    
@app.route('/trabajo_fdetalle/<string:idP>', methods=['GET'])
def trabajador_fdetalle(idP):
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()

    cursor.execute('select idTrabajador, nombreTrab from trabajadores order by idTrabajador')
    datos = cursor.fetchall()

    cursor.execute('SELECT idTrabajador, idArea, idPuesto, NombreTrab, '
               'edad, sexo, idEstadoCivil, idEscolaridad, idGradoAvance, idCarrera '
               'FROM trabajadores WHERE idTrabajador = %s', (idP,))
    dato = cursor.fetchall()


    cursor.execute('select a.idArea, a.descripcion from area a, trabajadores b where a.idArea = b.idArea and b.idTrabajador = %s', (idP))
    datos1 = cursor.fetchall()

    cursor.execute('select a.idPuesto, a.nomPuesto from puesto a, trabajadores b where a.idPuesto = b.idPuesto and b.idTrabajador = %s', (idP))
    datos2 = cursor.fetchall()

    cursor.execute('select a.idEstadoCivil, a.descripcion from estado_civil a, trabajadores b where a.idEstadoCivil = b.idEstadoCivil and b.idTrabajador = %s', (idP))
    datos3 = cursor.fetchall()

    cursor.execute('select a.idEscolaridad, a.descripcion from escolaridad a, trabajadores b where a.idEscolaridad = b.idEscolaridad and b.idTrabajador = %s', (idP))
    datos4 = cursor.fetchall()

    cursor.execute('select a.idGradoAvance, a.descripcion from grado_avance a, trabajadores b where a.idGradoAvance = b.idGradoAvance and b.idTrabajador = %s', (idP))
    datos5 = cursor.fetchall()

    cursor.execute('select a.idCarrera, a.descripcion from carrera a, trabajadores b where a.idCarrera = b.idCarrera and b.idTrabajador = %s', (idP))
    datos6 = cursor.fetchall()

   
    return render_template("trab_detalle.html", pue = datos, dat=dato[0], catArea=datos1[0],catPuesto=datos2[0], catEdoCivil=datos3[0], catEscolaridad=datos4[0],
                           catGradoAvance=datos5[0], catCarrera=datos6[0])
@app.route('/curso_agrOp2')
def curso_agrOp2():
    conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
    cursor = conn.cursor()
    cursor.execute('select id_curso, nombre from cursos ')
    datos1 = cursor.fetchall()

    cursor.execute('select idTrabajador, NombreTrab from trabajadores ')
    datos2 = cursor.fetchall()


    return render_template("addCurso.html", catCurso=datos1, catTrab=datos2)

@app.route('/addCurso', methods=['POST'])
def curso_fagrega():
    if request.method == 'POST':
        idT = request.form.get('idTrab')
        idCu = request.form.get('idCurso')

        try:
            conn = pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')
            cursor = conn.cursor()
            cursor.execute('insert into trabajadores_cursos (idTrabajador,idCurso) values (%s,%s)', (idT, idCu))
            conn.commit()
            cursor.close()
            conn.close()
        except pymysql.MySQLError as e:
            print(f"Error: {e}")
            # Aquí podrías agregar un manejo de errores más sofisticado, como registrar el error o notificar al usuario

        return redirect(url_for('trabajadores'))

def get_db_connection():
    return pymysql.connect(host='localhost', user='root', passwd='risemivicio125', db='rh4')

@app.route('/CursosTrab/<int:idTrabajador>', methods=['GET'])
def CursosTrab(idTrabajador):
    conn = get_db_connection()
    cursor = conn.cursor()

    # Obtener información del trabajador
    cursor.execute('SELECT NombreTrab FROM trabajadores WHERE idTrabajador = %s', (idTrabajador,))
    trabajador = cursor.fetchone()

    # Obtener los cursos asociados al trabajador
    cursor.execute('''
        SELECT c.id_curso, c.nombre, c.duracion
        FROM cursos c
        JOIN trabajadores_cursos tc ON c.id_curso = tc.idCurso
        WHERE tc.idTrabajador = %s
    ''', (idTrabajador,))
    cursos = cursor.fetchall()

    cursor.close()
    conn.close()

    return render_template("capacitacionesT.html", trabajador=trabajador, cursos=cursos)
